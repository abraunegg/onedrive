# -*-Dockerfile-*-

ARG ALPINE_VERSION=3.20

FROM alpine:${ALPINE_VERSION} AS builder-onedrive

RUN apk add --update --no-cache libstdc++ dmd curl-dev sqlite-dev make gcc libc-dev gpg-agent gpg bash curl xz git
WORKDIR /opt
RUN set -xv && \
    git clone https://github.com/abraunegg/onedrive.git && \
    cd onedrive && \
    ./configure --enable-debug && \
    make clean && make && \
    make install

FROM docker.io/alpine:${ALPINE_VERSION}

RUN apk add --upgrade apk-tools && \
    apk upgrade --available

RUN apk add --update --no-cache llvm-libunwind sqlite-libs libcurl bash shadow && \
    mkdir -p /onedrive/conf /onedrive/data

COPY --from=builder-onedrive /usr/local/bin/onedrive /usr/local/bin/

COPY ./entrypoint.sh /
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]